<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creative Crew - Property Management</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    
    <link rel="stylesheet" href="style.css">

    <style>
        /* Login Page Styles (Your Original Theme) */
        .login-wrapper { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .login-card { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 100%; max-width: 400px; text-align: center; }
        .login-logo { font-size: 24px; font-weight: 700; color: #1e3c72; margin-bottom: 8px; display: block; }
        .login-subtitle { color: #666; margin-bottom: 30px; font-size: 14px; }
        .login-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; box-sizing: border-box; }
        .login-btn { width: 100%; padding: 12px; background: #1e3c72; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer; transition: background 0.3s; }
        .login-btn:hover { background: #2a5298; }
        .error-msg { color: red; font-size: 12px; margin-top: 10px; display: none; }
        
        /* Helper for file input */
        #excel-upload { display: none; }
    </style>
</head>

<body>

    <div id="login-view" class="login-wrapper">
        <div class="login-card">
            <div class="login-logo">Creative Crew</div>
            <p class="login-subtitle">Sign in to manage your properties</p>
            <form onsubmit="handleLogin(event)">
                <input type="text" id="username" class="login-input" placeholder="Username" required>
                <input type="password" id="password" class="login-input" placeholder="Password" required>
                <button type="submit" class="login-btn">Sign In</button>
                <p id="login-error" class="error-msg">Invalid Credentials</p>
            </form>
        </div>
    </div>

    <div id="main-app" class="app-container" style="display: none;">
        <button class="mobile-menu-toggle" onclick="toggleSidebar()">‚ò∞</button>

        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">CC</div>
                    <span>Creative Crew</span>
                </div>
            </div>
            <nav>
                <ul class="nav-menu">
                    <li class="nav-item"><a class="nav-link active" onclick="navigateTo('dashboard')"><span class="nav-icon">üè†</span><span>Dashboard</span></a></li>
                    <li class="nav-item"><a class="nav-link" onclick="navigateTo('properties')"><span class="nav-icon">üè¢</span><span>All Properties</span></a></li>
                    <li class="nav-item"><a class="nav-link" onclick="navigateTo('add-property')"><span class="nav-icon">‚ûï</span><span>Add Property</span></a></li>
                    <li class="nav-item"><a class="nav-link" onclick="navigateTo('employees')"><span class="nav-icon">üë•</span><span>Employees</span></a></li>
                    <li class="nav-item"><a class="nav-link" onclick="navigateTo('add-employee')"><span class="nav-icon">üë§</span><span>Add Employee</span></a></li>
                    <li class="nav-item"><a class="nav-link" onclick="exportToExcel()"><span class="nav-icon">üì•</span><span>Export to Excel</span></a></li>
                </ul>
            </nav>
            <div style="padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); margin-top: auto;">
                <a onclick="handleLogout()" style="color: #ff6b6b; cursor: pointer; display: flex; align-items: center; gap: 10px; text-decoration: none;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                    <span>Logout</span>
                </a>
            </div>
        </aside>

        <main class="main-content">
            <div id="dashboard-page" class="page">
                <div class="page-header">
                    <h1 class="page-title">Dashboard</h1>
                    <p class="page-subtitle">Welcome to PropertyPro - Your Complete Property Management Solution</p>
                </div>
                <div class="stats-grid">
                    <div class="stat-card blue">
                        <div class="stat-header"><span class="stat-title">Total Properties</span><div class="stat-icon blue">üè¢</div></div>
                        <div class="stat-value" id="total-properties">0</div>
                        <div class="stat-label">Active listings</div>
                    </div>
                    <div class="stat-card green">
                        <div class="stat-header"><span class="stat-title">For Sale</span><div class="stat-icon green">üí∞</div></div>
                        <div class="stat-value" id="properties-for-sale">0</div>
                        <div class="stat-label">Available to purchase</div>
                    </div>
                    <div class="stat-card orange">
                        <div class="stat-header"><span class="stat-title">For Rent</span><div class="stat-icon orange">üîë</div></div>
                        <div class="stat-value" id="properties-for-rent">0</div>
                        <div class="stat-label">Available to rent</div>
                    </div>
                    <div class="stat-card purple">
                        <div class="stat-header"><span class="stat-title">Total Employees</span><div class="stat-icon purple">üë•</div></div>
                        <div class="stat-value" id="total-employees">0</div>
                        <div class="stat-label">Team members</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Recent Properties</h2>
                        <button class="btn btn-primary btn-sm" onclick="navigateTo('properties')">View All</button>
                    </div>
                    <div id="recent-properties-container"></div>
                </div>
            </div>

            <div id="properties-page" class="page hidden">
                <div class="page-header">
                    <h1 class="page-title">All Properties</h1>
                    <p class="page-subtitle">Manage your property listings</p>
                </div>
                <div class="card">
                    <div class="toolbar">
                        <div class="search-box">
                            <span class="search-icon">üîç</span>
                            <input type="text" class="form-control" placeholder="Search properties..." id="search-properties" oninput="filterProperties()">
                        </div>
                        <select class="form-control" id="filter-listing-type" onchange="filterProperties()" style="max-width: 150px;">
                            <option value="">All Listings</option>
                            <option value="For Sale">For Sale</option>
                            <option value="For Rent">For Rent</option>
                        </select>
                        <select class="form-control" id="filter-property-type" onchange="filterProperties()" style="max-width: 150px;">
                            <option value="">All Types</option>
                            <option value="Villa">Villa</option>
                            <option value="Plot">Plot</option>
                            <option value="Flat">Flat</option>
                            <option value="Commercial">Commercial</option>
                        </select>
                        
                        <input type="file" id="excel-upload" accept=".xlsx, .xls" onchange="handleFileSelect(event)">
                        <button class="btn btn-secondary" onclick="downloadTemplate()" title="Download Excel Format">üì• Template</button>
                        <button class="btn btn-primary" onclick="document.getElementById('excel-upload').click()">üì§ Import Excel</button>
                    </div>

                    <div class="table-container">
                        <table class="table" id="properties-table">
                            <thead>
                                <tr>
                                    <th>Image</th>
                                    <th>Property Name</th>
                                    <th>Owner</th>
                                    <th>Type</th>
                                    <th>BHK</th>
                                    <th>Location</th>
                                    <th>Price</th>
                                    <th>Listing</th>
                                    <th>Employee</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="properties-table-body"></tbody>
                        </table>
                    </div>
                    <div id="no-properties-message" class="empty-state hidden">
                        <div class="empty-state-icon">üìã</div>
                        <h3>No Properties Found</h3>
                        <p>Start by adding your first property</p>
                        <button class="btn btn-primary mt-24" onclick="navigateTo('add-property')">Add Property</button>
                    </div>
                </div>
            </div>

            <div id="add-property-page" class="page hidden">
                <div class="page-header">
                    <h1 class="page-title" id="property-form-title">Add New Property</h1>
                    <p class="page-subtitle">Fill in the property details</p>
                </div>
                <div class="card">
                    <form id="property-form">
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label required">Property Name</label><input type="text" class="form-control" id="property-name" required></div>
                            <div class="form-group"><label class="form-label required">Owner Name</label><input type="text" class="form-control" id="owner-name" required></div>
                            <div class="form-group"><label class="form-label required">Image Link</label><input type="text" class="form-control" id="property-image" placeholder="Paste image link here" required></div>
                            <div class="form-group"><label class="form-label required">Assigned Employee</label><select class="form-control" id="assigned-employee" required><option value="">Select Employee</option></select></div>
                            <div class="form-group"><label class="form-label required">Property Type</label><select class="form-control" id="property-type" required><option value="Villa">Villa</option><option value="Plot">Plot</option><option value="Flat">Flat</option><option value="Apartment">Apartment</option><option value="Commercial">Commercial Space</option></select></div>
                            <div class="form-group"><label class="form-label required">BHK Configuration</label><select class="form-control" id="bhk-type" required><option value="1BHK">1 BHK</option><option value="2BHK">2 BHK</option><option value="3BHK">3 BHK</option><option value="4BHK">4 BHK</option></select></div>
                            <div class="form-group"><label class="form-label required">Area (sq ft)</label><input type="number" class="form-control" id="area-sqft" required min="1"></div>
                            <div class="form-group"><label class="form-label required">Price (‚Çπ)</label><input type="number" class="form-control" id="price" required min="0"></div>
                            <div class="form-group"><label class="form-label required">Listing Type</label>
                                <div class="radio-group">
                                    <label class="radio-option"><input type="radio" name="listing-type" value="For Sale" required> For Sale</label>
                                    <label class="radio-option"><input type="radio" name="listing-type" value="For Rent" required> For Rent</label>
                                </div>
                            </div>
                            <div class="form-group full-width"><label class="form-label required">Location</label><input type="text" class="form-control" id="location" required></div>
                            <div class="form-group full-width"><label class="form-label">Description</label><textarea class="form-control" id="description" rows="4"></textarea></div>
                        </div>
                        <input type="hidden" id="property-id">
                        <div style="display: flex; gap: 12px; margin-top: 24px;">
                            <button type="button" class="btn btn-primary btn-lg" id="submit-property-btn" onclick="saveProperty(event)">‚úì Save Property</button>
                            <button type="button" class="btn btn-secondary btn-lg" onclick="resetPropertyForm()">Reset Form</button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="employees-page" class="page hidden">
                <div class="page-header">
                    <h1 class="page-title">Employees</h1>
                    <p class="page-subtitle">Manage your team members</p>
                </div>
                <div class="card">
                    <div class="toolbar">
                        <div class="search-box"><span class="search-icon">üîç</span><input type="text" class="form-control" placeholder="Search employees..." id="search-employees" oninput="filterEmployees()"></div>
                        <button class="btn btn-primary" onclick="navigateTo('add-employee')">‚ûï Add Employee</button>
                    </div>
                    <div class="table-container">
                        <table class="table" id="employees-table">
                            <thead><tr><th>ID</th><th>Name</th><th>Contact</th><th>Email</th><th>Role</th><th>Properties</th><th>Actions</th></tr></thead>
                            <tbody id="employees-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="add-employee-page" class="page hidden">
                <div class="page-header"><h1 class="page-title">Add New Employee</h1><p class="page-subtitle">Fill in employee details</p></div>
                <div class="card">
                    <form id="employee-form">
                        <div class="form-grid">
                            <div class="form-group"><label class="form-label required">Employee ID</label><input type="text" class="form-control" id="employee-id" required></div>
                            <div class="form-group"><label class="form-label required">Employee Name</label><input type="text" class="form-control" id="employee-name" required></div>
                            <div class="form-group"><label class="form-label required">Contact Number</label><input type="tel" class="form-control" id="employee-contact" required></div>
                            <div class="form-group"><label class="form-label required">Email</label><input type="email" class="form-control" id="employee-email" required></div>
                            <div class="form-group full-width"><label class="form-label required">Role</label><select class="form-control" id="employee-role" required><option value="Agent">Agent</option><option value="Manager">Manager</option></select></div>
                        </div>
                        <input type="hidden" id="employee-edit-id">
                        <div style="display: flex; gap: 12px; margin-top: 24px;">
                            <button type="button" class="btn btn-primary btn-lg" id="submit-employee-btn" onclick="saveEmployee(event)">‚úì Save Employee</button>
                            <button type="button" class="btn btn-secondary btn-lg" onclick="resetEmployeeForm()">Reset Form</button>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <div id="toast-container"></div>
    <div id="modal-container"></div>

    <script>
        // --- 1. CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyC-8DGxz2aABfonDbHvlIwQuicSqckjufc",
            authDomain: "property-manager-326bf.firebaseapp.com",
            projectId: "property-manager-326bf",
            storageBucket: "property-manager-326bf.appspot.com",
            messagingSenderId: "1060819586713",
            appId: "1:1060819586713:web:9ec3fcc365d931cb4f7208"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- GLOBAL VARIABLES ---
        let properties = [];
        let employees = [];
        let editingPropertyId = null;
        let editingEmployeeId = null;

        // --- 2. AUTHENTICATION ---
        document.addEventListener('DOMContentLoaded', () => {
            const isLoggedIn = sessionStorage.getItem('isLoggedIn') === 'true';
            if (isLoggedIn) {
                document.getElementById('login-view').style.display = 'none';
                document.getElementById('main-app').style.display = 'flex';
                loadInitialData();
            } else {
                document.getElementById('login-view').style.display = 'flex';
                document.getElementById('main-app').style.display = 'none';
            }
        });

        function handleLogin(event) {
            event.preventDefault();
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            if (user === 'admin' && pass === '1234') {
                sessionStorage.setItem('isLoggedIn', 'true');
                location.reload();
            } else {
                document.getElementById('login-error').style.display = 'block';
            }
        }

        function handleLogout() {
            sessionStorage.removeItem('isLoggedIn');
            location.reload();
        }

        // --- 3. EXCEL LOGIC (NEW) ---
        function downloadTemplate() {
            const data = [
                { "Property Name": "Sunset Villa", "Owner Name": "John Doe", "Price": 5000000, "Location": "Jaipur", "Property Type": "Villa", "BHK": "3BHK", "Listing Type": "For Sale", "Area": 2500, "Image Link": "https://example.com/img.jpg" }
            ];
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Template");
            XLSX.writeFile(wb, "Property_Template.xlsx");
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                if (jsonData.length > 0) processExcelData(jsonData);
                else showToast("File is empty", "error");
            };
            reader.readAsArrayBuffer(file);
            event.target.value = ''; // Reset
        }

        async function processExcelData(data) {
            let count = 0;
            showToast(`Uploading ${data.length} properties...`, "info");
            
            for (const row of data) {
                const docData = {
                    propertyName: row["Property Name"] || "Unknown",
                    ownerName: row["Owner Name"] || "Unknown",
                    price: Number(row["Price"]) || 0,
                    location: row["Location"] || "Jaipur",
                    propertyType: row["Property Type"] || "Plot",
                    bhkType: row["BHK"] || "N/A",
                    listingType: row["Listing Type"] || "For Sale",
                    areaSqft: Number(row["Area"]) || 0,
                    imageUrl: row["Image Link"] || "",
                    description: "Imported via Excel",
                    dateAdded: firebase.firestore.FieldValue.serverTimestamp(),
                    assignedEmployee: "Admin"
                };
                await db.collection("properties").add(docData);
                count++;
            }
            showToast(`Successfully imported ${count} properties!`, "success");
            loadInitialData();
        }

        // --- 4. APP LOGIC ---
        async function loadInitialData() {
            try {
                const pSnap = await db.collection("properties").orderBy("dateAdded", "desc").get();
                properties = pSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                const eSnap = await db.collection("employees").get();
                employees = eSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                updateDashboard();
                displayProperties();
                displayEmployees();
                updateEmployeeDropdown();
            } catch (error) {
                console.error(error);
                showToast("Error loading data", "error");
            }
        }

        async function saveProperty(event) {
            event.preventDefault();
            const btn = document.getElementById('submit-property-btn');
            btn.innerText = "Saving...";
            btn.disabled = true;

            const radio = document.querySelector('input[name="listing-type"]:checked');
            const listingVal = radio ? radio.value : "For Sale";

            const propertyData = {
                propertyName: document.getElementById('property-name').value,
                ownerName: document.getElementById('owner-name').value,
                imageUrl: document.getElementById('property-image').value,
                assignedEmployee: document.getElementById('assigned-employee').value,
                bhkType: document.getElementById('bhk-type').value,
                price: parseFloat(document.getElementById('price').value) || 0,
                listingType: listingVal,
                propertyType: document.getElementById('property-type').value,
                areaSqft: parseInt(document.getElementById('area-sqft').value) || 0,
                location: document.getElementById('location').value,
                description: document.getElementById('description').value,
                dateAdded: firebase.firestore.FieldValue.serverTimestamp()
            };

            if (editingPropertyId) {
                await db.collection("properties").doc(editingPropertyId).update(propertyData);
                showToast('Updated successfully!', 'success');
                editingPropertyId = null;
            } else {
                await db.collection("properties").add(propertyData);
                showToast('Added successfully!', 'success');
            }

            resetPropertyForm();
            loadInitialData();
            navigateTo('properties');
            btn.innerText = "‚úì Save Property";
            btn.disabled = false;
        }

        function displayProperties() {
            const tbody = document.getElementById('properties-table-body');
            tbody.innerHTML = properties.map(p => `
                <tr>
                    <td>${p.imageUrl ? `<img src="${p.imageUrl}" style="width:40px; height:40px; border-radius:4px; object-fit:cover;">` : 'üè†'}</td>
                    <td><strong>${p.propertyName}</strong></td>
                    <td>${p.ownerName}</td>
                    <td>${p.propertyType}</td>
                    <td>${p.bhkType}</td>
                    <td>${p.location}</td>
                    <td>‚Çπ${p.price.toLocaleString()}</td>
                    <td><span class="badge ${p.listingType === 'For Rent' ? 'badge-rent' : 'badge-sale'}">${p.listingType}</span></td>
                    <td>${p.assignedEmployee}</td>
                    <td>
                        <button class="btn btn-secondary btn-sm" onclick="editProperty('${p.id}')">‚úèÔ∏è</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteProperty('${p.id}')">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }

        function editProperty(id) {
            const p = properties.find(x => x.id === id);
            if(!p) return;
            editingPropertyId = id;
            document.getElementById('property-name').value = p.propertyName;
            document.getElementById('owner-name').value = p.ownerName;
            document.getElementById('property-image').value = p.imageUrl || "";
            document.getElementById('price').value = p.price;
            document.getElementById('location').value = p.location;
            document.getElementById('area-sqft').value = p.areaSqft;
            document.getElementById('description').value = p.description || "";
            navigateTo('add-property');
        }

        async function deleteProperty(id) {
            if(confirm("Delete this property?")) {
                await db.collection("properties").doc(id).delete();
                showToast("Deleted!", "success");
                loadInitialData();
            }
        }

        // --- EMPLOYEE FUNCTIONS ---
        async function saveEmployee(event) {
            const data = {
                employeeId: document.getElementById('employee-id').value,
                name: document.getElementById('employee-name').value,
                contact: document.getElementById('employee-contact').value,
                email: document.getElementById('employee-email').value,
                role: document.getElementById('employee-role').value
            };
            await db.collection("employees").add(data);
            showToast("Employee Added", "success");
            resetEmployeeForm();
            loadInitialData();
            navigateTo('employees');
        }

        function displayEmployees() {
            const tbody = document.getElementById('employees-table-body');
            tbody.innerHTML = employees.map(e => `<tr><td>${e.employeeId}</td><td>${e.name}</td><td>${e.contact}</td><td>${e.email}</td><td>${e.role}</td><td>-</td><td><button>Edit</button></td></tr>`).join('');
        }

        function updateEmployeeDropdown() {
            const sel = document.getElementById('assigned-employee');
            sel.innerHTML = '<option value="">Select</option>' + employees.map(e => `<option value="${e.name}">${e.name}</option>`).join('');
        }

        // --- UTILS ---
        function resetPropertyForm() { document.getElementById('property-form').reset(); editingPropertyId = null; }
        function resetEmployeeForm() { document.getElementById('employee-form').reset(); }
        
        function updateDashboard() {
            document.getElementById('total-properties').innerText = properties.length;
            document.getElementById('total-employees').innerText = employees.length;
            document.getElementById('properties-for-sale').innerText = properties.filter(p => p.listingType === 'For Sale').length;
            document.getElementById('properties-for-rent').innerText = properties.filter(p => p.listingType === 'For Rent').length;
        }

        function navigateTo(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            document.getElementById(page + '-page').classList.remove('hidden');
            if(window.innerWidth < 768) document.getElementById('sidebar').classList.remove('open');
        }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
        function showToast(msg, type) {
            const t = document.createElement('div'); t.className = `toast ${type}`; t.innerText = msg;
            document.getElementById('toast-container').appendChild(t); setTimeout(() => t.remove(), 3000);
        }
    </script>
</body>
</html>
